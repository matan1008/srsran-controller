import datetime

from pyshark import FileCapture

from srsran_controller.uu_events.factory import EventsFactory

DETACH_REQUEST_PCAP_DATA = (
    '0a0d0d0adc0000004d3c2b1a01000000ffffffffffffffff02003b00313174682047656e20496e74656c28522920436f726528544d292069'
    '372d3131373030204020322e353047487a20287769746820535345342e322900030017004c696e757820352e31352e302d35362d67656e65'
    '7269630004005b0044756d70636170202857697265736861726b2920332e362e3720284769742076332e362e37207061636b616765642061'
    '7320332e362e372d317e7562756e747532322e30342e302b77697265736861726b646576737461626c65290000000000dc00000001000000'
    '60000000010000000000040002000b006c74652d6e6574776f726b0009000100090000000b000e000075647020706f727420353834370000'
    '0c0017004c696e757820352e31352e302d35362d67656e65726963000000000060000000060000006c0200000000000015f331170a37cb24'
    '490200004902000002424b733f030242c0a8340208004500023b95bb40004011b8a5c0a83402c0a834fe163716d70227ec896d61632d6c74'
    '650100030200810300000405b607010a000f00013d3a221f1f0000a000004802a4ff92891b0060e8a3617ec13e20e000234673ec0700a3fb'
    'e4b1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000006c020000050000006c000000000000001df00500'
    'a5d1d17701001c00436f756e746572732070726f76696465642062792064756d70636170020008001df0050048636574030008001df00500'
    '7fd1d17704000800e400000000000000050008000000000000000000000000006c000000'
)


def test_parsing_emm_detach_request(tmp_path):
    p = tmp_path / 'detach_request.pcap'
    p.write_bytes(bytes.fromhex(DETACH_REQUEST_PCAP_DATA))
    with FileCapture(str(p), use_json=True) as pcap:
        detach = list(EventsFactory().from_packet(list(pcap)[0]))[0]
    assert detach == {
        'tmsi': 0x339f6038,
        'event': 'Detach request',
        'rnti': 129,
        'time': datetime.datetime(2022, 12, 18, 19, 23, 28, 868325),
        'enb_ip': '192.168.52.2',
    }
