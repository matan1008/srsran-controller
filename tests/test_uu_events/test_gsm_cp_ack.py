import datetime

from pyshark import FileCapture

from srsran_controller.uu_events.factory import EventsFactory
from srsran_controller.uu_events.gsm_cp_ack import GSM_CP_ACK_NAME

GSM_CP_ACK_PCAP_DATA = (
    '0a0d0d0abc0000004d3c2b1a01000000ffffffffffffffff02003b00313174682047656e20496e74656c28522920436f726528544d292069'
    '372d3131373030204020322e353047487a20287769746820535345342e322900030017004c696e757820352e31332e302d33302d67656e65'
    '7269630004003a0044756d70636170202857697265736861726b2920332e322e3320284769742076332e322e33207061636b616765642061'
    '7320332e322e332d3129000000000000bc0000000100000058000000710000000000040002000300616e790009000100090000000b000e00'
    '0075647020706f7274203538343700000c0017004c696e757820352e31332e302d33302d67656e6572696300000000005800000006000000'
    '6c020000000000001673e016172fcdf14b0200004b0200000000000100060242c0a8340237c908004500023ba17640004011aceac0a83402'
    'c0a834fe163716d70227ec896d61632d6c746501000302004603000004000807010a000f00013d3a220222151f00000008a00101480164ee'
    '538a94a040ec60572080d2b9b453000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    '000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006c020000'
    '050000006c0000000000000040db05002852165501001c00436f756e746572732070726f76696465642062792064756d7063617002000800'
    '40db050068393c410300080040db05002652165504000800660c000000000000050008000000000000000000000000006c000000'
)


def test_parsing_gsm_cp_ack(tmp_path):
    p = tmp_path / 'gsm_cp_ack.pcap'
    p.write_bytes(bytes.fromhex(GSM_CP_ACK_PCAP_DATA))
    with FileCapture(str(p), use_json=True) as pcap:
        cp_ack = list(EventsFactory().from_packet(list(pcap)[0]))[0]
    assert cp_ack == {
        'event': GSM_CP_ACK_NAME,
        'rnti': 70,
        'time': datetime.datetime(2022, 3, 28, 8, 6, 46, 832),
        'enb_ip': '192.168.52.2',
    }
