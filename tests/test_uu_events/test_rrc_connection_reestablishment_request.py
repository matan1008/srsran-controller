import datetime

from pyshark import FileCapture

from srsran_controller.uu_events.factory import EventsFactory
from srsran_controller.uu_events.rrc_connection_reestablishment_request import CONNECTION_REESTABLISHMEMT_REQUEST_NAME

RRC_CONNECTION_REESTABLISHMENT_REQUEST_PCAP_DATA = (
    '0a0d0d0ab80000004d3c2b1a01000000ffffffffffffffff02003500496e74656c28522920436f726528544d292069372d373730302043'
    '5055204020332e363047487a20287769746820535345342e3229000000030017004c696e757820352e31312e302d33372d67656e657269'
    '630004003a0044756d70636170202857697265736861726b2920332e322e3320284769742076332e322e33207061636b61676564206173'
    '20332e322e332d3129000000000000b80000000100000060000000010000000000040002000b006c74652d6e6574776f726b0009000100'
    '090000000b000e000075647020706f7274203538343700000c0017004c696e757820352e31312e302d33372d67656e6572696300000000'
    '0060000000060000006c00000000000000a57db116f5bc85ea4b0000004b00000002420c93c8ca0242c0a8340208004500003d55094000'
    '4011fb55c0a83402c0a834fe163716d70029ea8b6d61632d6c7465010003020047030000041b2207010a000f0001000008d4d269d8006c'
    '000000050000006c000000000000003acf0500d185b7d501001c00436f756e746572732070726f76696465642062792064756d70636170'
    '020008003acf0500496c63c7030008003acf05003d85b7d5040008008201000000000000050008000000000000000000000000006c0000'
    '00'
)


def test_parsing_connection_reestablishment_request(tmp_path):
    p = tmp_path / 'rrc_connection_reestablishment_request.pcap'
    p.write_bytes(bytes.fromhex(RRC_CONNECTION_REESTABLISHMENT_REQUEST_PCAP_DATA))
    with FileCapture(str(p), use_json=True) as pcap:
        connection_reestablishment_request = list(EventsFactory().from_packet(list(pcap)[0]))[0]
    assert connection_reestablishment_request == {
        'event': CONNECTION_REESTABLISHMEMT_REQUEST_NAME,
        'physical_cell_id': 333,
        'c-rnti': 70,
        'rnti': 71,
        'time': datetime.datetime(2021, 10, 26, 8, 31, 31, 269910),
    }
